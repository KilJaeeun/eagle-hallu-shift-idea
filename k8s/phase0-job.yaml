apiVersion: batch/v1
kind: Job
metadata:
  name: eagle-hallushift-phase0
  labels:
    project: eagle-hallushift
    phase: "0"
spec:
  backoffLimit: 2
  template:
    metadata:
      labels:
        project: eagle-hallushift
        phase: "0"
    spec:
      restartPolicy: Never
      tolerations:
      - key: "accelerator"
        operator: "Equal"
        value: "h200"
        effect: "NoSchedule"
      - key: "nvidia.com/gpu"
        operator: "Exists"
        effect: "NoSchedule"
      containers:
      - name: phase0
        image: nvidia/cuda:12.1.0-cudnn8-devel-ubuntu22.04
        resources:
          limits:
            nvidia.com/gpu: 1
          requests:
            nvidia.com/gpu: 1
            memory: "80Gi"
            cpu: "8"
        env:
        - name: HF_TOKEN
          valueFrom:
            secretKeyRef:
              name: eagle-hallushift-secrets
              key: hf-token
        - name: WANDB_API_KEY
          valueFrom:
            secretKeyRef:
              name: eagle-hallushift-secrets
              key: wandb-api-key
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "=== Phase 0: Validation Study ==="

          # Install system dependencies
          apt-get update && apt-get install -y git python3 python3-pip
          ln -sf /usr/bin/python3 /usr/bin/python
          ln -sf /usr/bin/pip3 /usr/bin/pip

          # Clone repo
          git clone https://github.com/KilJaeeun/eagle-hallu-shift-idea.git
          cd eagle-hallu-shift-idea

          # Clone and install EAGLE first (it has specific version requirements)
          if [ ! -d "EAGLE" ]; then
            git clone https://github.com/SafeAILab/EAGLE.git
          fi
          pip install -e EAGLE

          # Install additional dependencies (scipy, huggingface_hub for upload)
          pip install scipy huggingface_hub[cli] --no-deps || pip install scipy huggingface_hub

          # Refresh shell hash table
          hash -r
          export PATH="/opt/conda/bin:$PATH"

          # Login to HuggingFace using python module
          python -c "from huggingface_hub import login; login(token='$HF_TOKEN')"

          # Run Phase 0
          python scripts/phase0_inference_hook.py \
            --base_model meta-llama/Llama-2-7b-chat-hf \
            --ea_model yuhuili/EAGLE-llama2-chat-7B \
            --max_samples 200 \
            --output_dir phase0_results

          # Upload results to HuggingFace
          echo "Uploading results..."
          python -c "from huggingface_hub import HfApi; api = HfApi(); api.upload_folder(folder_path='./phase0_results', repo_id='kje2952/eagle-hallu-shift', repo_type='model', path_in_repo='phase0_results')"

          echo "=== Phase 0 Complete ==="
